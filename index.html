<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Welsing Zeiten – v1.6.5 kompakt + Monteur (stabil)</title>
  <meta name="theme-color" content="#E2231A">
  <style>
    :root{
      --bg:#0b0c10;
      --card:#15171c;
      --ink:#fff;
      --muted:#c7c7c9;
      --accent:#F28C00;
      --accent-ink:#1a1300;
      --primary:#E2231A;
      --line:#2a2e36;
      --focus:#FBB040;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:15px/1.35 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    header{
      padding:8px 10px;
      position:sticky;
      top:0;
      z-index:9;
      background:var(--primary);
      border-bottom:3px solid var(--focus);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .ver{
      font-size:11px;
      background:#00000033;
      border:1px solid #ffffff33;
      padding:2px 6px;
      border-radius:8px;
    }
    .wrap{padding:10px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      margin:8px 0;
    }
    .row{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .grid{display:grid;gap:6px}
    .cols2{grid-template-columns:1fr 1fr}
    @media(max-width:720px){.cols2{grid-template-columns:1fr}}
    label{font-size:11px;color:var(--muted)}
    input,select,textarea,button{font-size:14px}
    input[type="text"],textarea,select{
      background:#0f1116;
      border:1px solid var(--line);
      border-radius:8px;
      padding:6px 8px;
      min-height:32px;
      width:100%;
      -webkit-text-fill-color:#fff;
      color:#fff;
      caret-color:var(--focus);
    }
    textarea{min-height:70px}
    table{
      border-collapse:collapse;
      width:100%;
      background:#0f1116;
      border-radius:8px;
      overflow:hidden;
      font-size:11px;
    }
    th,td{
      border:1px solid var(--line);
      padding:3px 4px;
      text-align:center;
    }
    thead th{
      background:var(--focus);
      color:#000;
      font-weight:700;
    }
    .btn{
      background:var(--accent);
      color:var(--accent-ink);
      border:0;
      border-radius:8px;
      padding:6px 9px;
      font-weight:700;
      cursor:pointer;
      min-height:28px;
      font-size:11px;
    }
    .btn.secondary{
      background:transparent;
      color:#fff;
      border:1px solid var(--accent);
    }
    .pill{
      display:inline-block;
      background:#0f1116;
      border:1px solid var(--line);
      border-radius:999px;
      padding:3px 7px;
      font-size:10px;
    }
    iframe#printFrame{
      position:fixed;
      left:-9999px;
      top:-9999px;
      width:0;
      height:0;
      border:0;
    }
    .hcell input{
      -webkit-appearance:none;
      appearance:none;
      background:#0f1116!important;
      border:0;
      width:100%;
      text-align:center;
      font-size:12px;
      font-weight:600;
      color:#ffffff!important;
      -webkit-text-fill-color:#ffffff!important;
      padding:1px;
    }
    .hcell input::placeholder{color:#555}
  </style>
</head>
<body>
<header>
  <b>Welsing Zeiten</b>
  <div class="ver">v1.6.5 kompakt + Monteur</div>
</header>

<div class="wrap">
  <!-- Kopf -->
  <div class="card">
    <div class="grid cols2">
      <div>
        <label>KW</label>
        <input id="kw" type="text" placeholder="z. B. KW 42">
      </div>
      <div>
        <label>Zeitraum</label>
        <input id="zr" type="text" placeholder="z. B. 13.10.–18.10.2025">
      </div>
    </div>
    <div class="grid cols2">
      <div>
        <label>Monteur-Team (Komma)</label>
        <input id="team" type="text" placeholder="Kevin, Jacub, Mario, Martin, Tomas">
      </div>
      <div>
        <label>Sonntag</label>
        <select id="sun">
          <option value="0">aus</option>
          <option value="1">an</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:4px">
      <button class="btn" id="btnWeeklyAll">Wochenbericht (alle) PDF</button>
      <select id="selMonteur" title="Monteur wählen"></select>
      <button class="btn secondary" id="btnWeeklyMonteur">PDF Monteur Woche</button>
      <button class="btn secondary" id="btnWipe">Daten löschen</button>
    </div>
  </div>

  <!-- Kunden -->
  <div class="card">
    <div class="row" style="margin-bottom:4px">
      <button class="btn secondary" id="btnAddK">+ Kunde</button>
      <button class="btn secondary" id="btnRemK">− Kunde</button>
      <select id="sel"></select>
      <button class="btn" id="btnScroll">Zu Kunde</button>
    </div>
    <div id="kunden"></div>
  </div>
</div>

<iframe id="printFrame"></iframe>

<script>
(function(){
  const KEY = "wz_v165_compact_monteur";
  let st = {
    kw: "",
    zr: "",
    tage: ["Mo","Di","Mi","Do","Fr","Sa"],
    team: ["Kevin","Jacub","Mario","Martin","Tomas"],
    k: []
  };
  let lastSel = 0;
  let delegatesAttached = false;

  // Bei ?wipe=1 alles löschen
  try {
    const usp = new URLSearchParams(location.search);
    if (usp.get("wipe") === "1") {
      localStorage.removeItem(KEY);
    }
  } catch(e){}

  function escapeHtml(s){
    return (s || "").toString()
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }
  function escapeAttr(s){
    return (s || "").toString()
      .replace(/&/g,"&amp;")
      .replace(/"/g,"&quot;");
  }

  function save(){
    try { localStorage.setItem(KEY, JSON.stringify(st)); } catch(e){}
  }

  function load(){
    try {
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const o = JSON.parse(raw) || {};
      if(o.kw) st.kw = o.kw;
      if(o.zr) st.zr = o.zr;
      if(Array.isArray(o.tage) && o.tage.length) st.tage = o.tage;
      if(Array.isArray(o.team) && o.team.length) st.team = o.team;
      if(Array.isArray(o.k) && o.k.length) st.k = o.k;
    } catch(e){}
  }

  function newK(){
    return {
      n: "",
      a: "",
      az: "",
      ag: "",
      h: st.team.map(() => st.tage.map(() => "")),
      m: [{b:"",s:"",r:""}]
    };
  }

  function ensureAtLeastOneKunde(){
    if(!Array.isArray(st.k) || st.k.length === 0){
      st.k = [newK()];
    }
  }

  function fixShapes(){
    ensureAtLeastOneKunde();
    st.k.forEach(k => {
      if(!Array.isArray(k.h)) k.h = [];
      while(k.h.length < st.team.length){
        k.h.push(st.tage.map(() => ""));
      }
      while(k.h.length > st.team.length){
        k.h.pop();
      }
      for(let r=0; r<k.h.length; r++){
        if(!Array.isArray(k.h[r])) k.h[r] = [];
        while(k.h[r].length < st.tage.length){
          k.h[r].push("");
        }
        while(k.h[r].length > st.tage.length){
          k.h[r].pop();
        }
      }
      if(!Array.isArray(k.m) || k.m.length === 0){
        k.m = [{b:"",s:"",r:""}];
      }
    });
  }

  function addKunde(){
    st.k.push(newK());
    render();
    setSel(st.k.length - 1);
    save();
  }

  function remKunde(){
    if(st.k.length <= 1){
      alert("Mindestens 1 Kunde nötig.");
      return;
    }
    st.k.splice(lastSel, 1);
    if(lastSel >= st.k.length) lastSel = st.k.length - 1;
    render();
    setSel(lastSel);
    save();
  }

  function setSel(v){
    lastSel = parseInt(v || "0", 10) || 0;
    const sel = document.getElementById("sel");
    if(sel) sel.value = String(lastSel);
  }

  function scrollSel(){
    const el = document.getElementById("k"+lastSel);
    if(el) el.scrollIntoView({behavior:"smooth"});
  }

  function toggleSun(v){
    if(v === "1"){
      if(!st.tage.includes("So")) st.tage.push("So");
    } else {
      st.tage = st.tage.filter(t => t !== "So");
    }
    fixShapes();
    render();
    save();
  }

  function applyTeam(){
    const raw = document.getElementById("team").value;
    const arr = raw.split(",").map(s => s.trim()).filter(Boolean);
    if(arr.length){
      st.team = arr;
      fixShapes();
      render();
      save();
    }
  }

  function sanitizeDec(s){
    s = (s || "").toString().replace(/,/g,".").replace(/[^0-9.]/g,"");
    const p = s.indexOf(".");
    if(p >= 0){
      s = s.slice(0,p+1) + s.slice(p+1).replace(/\./g,"");
    }
    return s;
  }

  function setH(i,r,d,v){
    v = sanitizeDec(v);
    const k = st.k[i];
    if(k && k.h && k.h[r]){
      k.h[r][d] = v;
      save();
      renderRowSum(i,r);
    }
  }

  function setF(i,f,v){
    const k = st.k[i];
    if(k){
      k[f] = v;
      save();
    }
  }

  function addM(i){
    const k = st.k[i];
    if(k){
      k.m.push({b:"",s:"",r:""});
      save();
      render();
    }
  }

  function delM(i,m){
    const k = st.k[i];
    if(k && k.m && k.m[m] != null){
      k.m.splice(m,1);
      if(k.m.length === 0) k.m.push({b:"",s:"",r:""});
      save();
      render();
    }
  }

  function setM(i,m,f,v){
    const k = st.k[i];
    if(k && k.m && k.m[m]){
      k.m[m][f] = v;
      save();
    }
  }

  function renderRowSum(i,r){
    const card = document.getElementById("k"+i);
    if(!card) return;
    const tr = card.querySelector(`tr[data-r="${r}"]`);
    if(!tr) return;
    const inputs = tr.querySelectorAll("td.hcell input");
    let sum = 0;
    inputs.forEach(inp => {
      const v = (inp.value || "").replace(/,/g,".");
      const n = parseFloat(v);
      if(!isNaN(n)) sum += n;
    });
    const last = tr.querySelector("td.sum-cell");
    if(last) last.innerHTML = `<b>${sum.toFixed(2)}</b>`;
  }

  function cardHTML(i){
    const c = st.k[i];

    // Stunden-Zeilen
    let rows = "";
    for(let r=0; r<st.team.length; r++){
      rows += `<tr data-r="${r}"><th style="text-align:left">${escapeHtml(st.team[r])}</th>`;
      for(let d=0; d<st.tage.length; d++){
        const v = (c.h && c.h[r] && c.h[r][d]) || "";
        rows += `<td class="hcell"><input type="tel" inputmode="decimal" placeholder="0"
                  value="${escapeAttr(v)}"
                  data-i="${i}" data-r="${r}" data-d="${d}"></td>`;
      }
      rows += `<td class="sum-cell"><b>0.00</b></td></tr>`;
    }

    // Material
    let mats = "";
    c.m.forEach((m,idx) => {
      mats += `<tr>
        <td><input type="text" value="${escapeAttr(m.b)}" data-i="${i}" data-m="${idx}" data-f="b"></td>
        <td><input type="text" value="${escapeAttr(m.s)}" data-i="${i}" data-m="${idx}" data-f="s"></td>
        <td><input type="text" value="${escapeAttr(m.r)}" data-i="${i}" data-m="${idx}" data-f="r"></td>
        <td><button class="btn secondary" data-action="delM" data-i="${i}" data-m="${idx}">−</button></td>
      </tr>`;
    });
    if(!mats){
      mats = `<tr><td colspan="4" style="text-align:center;color:#666">—</td></tr>`;
    }

    return `
      <div class="card" id="k${i}">
        <div class="row">
          <span class="pill">Kunde ${String(i+1).padStart(2,"0")}</span>
          <button class="btn" data-action="printK" data-i="${i}" style="margin-left:auto">PDF Arbeitsbericht</button>
        </div>
        <div class="grid cols2" style="margin-top:4px">
          <div><label>Name</label>
            <input type="text" value="${escapeAttr(c.n)}" data-action="setF" data-i="${i}" data-f="n">
          </div>
          <div><label>Adresse</label>
            <input type="text" value="${escapeAttr(c.a)}" data-action="setF" data-i="${i}" data-f="a">
          </div>
        </div>
        <div class="grid cols2" style="margin-top:4px">
          <div><label>Auszuführende Arbeit</label>
            <textarea data-action="setF" data-i="${i}" data-f="az">${escapeHtml(c.az)}</textarea>
          </div>
          <div><label>Ausgeführte Arbeit</label>
            <textarea data-action="setF" data-i="${i}" data-f="ag">${escapeHtml(c.ag)}</textarea>
          </div>
        </div>
        <div style="margin-top:6px">
          <b>Stunden</b>
          <table>
            <thead>
              <tr>
                <th>M.</th>
                ${st.tage.map(t => `<th>${t}</th>`).join("")}
                <th>Summe</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <div style="margin-top:6px">
          <b>Material</b>
          <button class="btn secondary" data-action="addM" data-i="${i}">+ Pos.</button>
          <table style="margin-top:4px">
            <thead>
              <tr><th>Bezeichnung</th><th>Menge</th><th>Bemerkung</th><th></th></tr>
            </thead>
            <tbody>${mats}</tbody>
          </table>
        </div>
      </div>`;
  }

  function render(){
    fixShapes();

    // Kopf
    document.getElementById("kw").value = st.kw;
    document.getElementById("zr").value = st.zr;
    document.getElementById("sun").value = st.tage.includes("So") ? "1" : "0";
    document.getElementById("team").value = st.team.join(", ");

    // Monteur-Auswahl
    const selMonteur = document.getElementById("selMonteur");
    selMonteur.innerHTML = st.team
      .map((n,idx) => `<option value="${idx}">${escapeHtml(n)}</option>`)
      .join("");

    // Kunden-Auswahl
    const sel = document.getElementById("sel");
    sel.innerHTML = st.k.map((k,i) =>
      `<option value="${i}">${String(i+1).padStart(2,"0")} — ${escapeHtml(k.n || "Kunde")}</option>`
    ).join("") || `<option value="0">01 — Kunde</option>`;

    // Kundenkarten
    const kundenDiv = document.getElementById("kunden");
    kundenDiv.innerHTML = st.k.map((_,i) => cardHTML(i)).join("");

    attachDelegatesOnce();
    setTimeout(computeAllVisibleSums,0);
  }

  function attachDelegatesOnce(){
    if(delegatesAttached) return;
    delegatesAttached = true;

    // Kopf
    document.getElementById("kw").addEventListener("input", e => { st.kw = e.target.value; save(); });
    document.getElementById("zr").addEventListener("input", e => { st.zr = e.target.value; save(); });
    document.getElementById("sun").addEventListener("change", e => toggleSun(e.target.value));
    const teamInput = document.getElementById("team");
    teamInput.addEventListener("input", applyTeam);
    teamInput.addEventListener("change", applyTeam);

    // Buttons oben
    document.getElementById("btnWeeklyAll").addEventListener("click", printWeekly);
    document.getElementById("btnWeeklyMonteur").addEventListener("click", () => {
      const sel = document.getElementById("selMonteur");
      const r = parseInt(sel.value || "0", 10) || 0;
      printMonteurWeekly(r);
    });
    document.getElementById("btnWipe").addEventListener("click", () => {
      if(confirm("Alle Daten dieser Woche wirklich löschen?")){
        try{ localStorage.removeItem(KEY); }catch(e){}
        location.href='?wipe=1&cb='+(Date.now());
      }
    });

    // Kundensteuerung
    document.getElementById("btnAddK").addEventListener("click", addKunde);
    document.getElementById("btnRemK").addEventListener("click", remKunde);
    document.getElementById("sel").addEventListener("change", e => setSel(e.target.value));
    document.getElementById("btnScroll").addEventListener("click", scrollSel);

    // Delegation im Kundenbereich
    const kc = document.getElementById("kunden");

    kc.addEventListener("input", e => {
      const t = e.target;
      if(t.matches("td.hcell input")){
        setH(+t.dataset.i, +t.dataset.r, +t.dataset.d, t.value);
        return;
      }
      if(t.dataset.action === "setF"){
        setF(+t.dataset.i, t.dataset.f, t.value);
        return;
      }
      if(t.dataset.f && t.dataset.m !== undefined){
        setM(+t.dataset.i, +t.dataset.m, t.dataset.f, t.value);
        return;
      }
    });

    kc.addEventListener("click", e => {
      const b = e.target.closest("button[data-action]");
      if(!b) return;
      const act = b.dataset.action;
      const i = +b.dataset.i;
      if(act === "addM") addM(i);
      else if(act === "delM") delM(i, +b.dataset.m);
      else if(act === "printK") printK(i);
    });

    // Autosave
    window.addEventListener("beforeunload", () => { try{ save(); }catch(e){} });
    setInterval(() => { try{ save(); }catch(e){} }, 3000);
  }

  // --- PDF Hilfsfunktionen ---
  function pdfHeader(title){
    return `<div style="margin-bottom:4px;font-weight:700">${title}</div>`;
  }

  function writePrint(html){
    const fr = document.getElementById("printFrame");
    const win = fr.contentWindow || fr;
    const doc = win.document;
    doc.open();
    doc.write(html);
    doc.close();
  }

  function printK(i){
    const c = st.k[i];
    const head = st.tage.map(t => `<th>${t}</th>`).join("");
    let rows = "";
    st.team.forEach((name,r) => {
      let sum = 0;
      let cells = "";
      st.tage.forEach((_,d) => {
        const n = parseFloat(c.h[r]?.[d] || 0) || 0;
        sum += n;
        cells += `<td>${n.toFixed(2)}</td>`;
      });
      rows += `<tr><th style="text-align:left">${escapeHtml(name)}</th>${cells}<td><b>${sum.toFixed(2)}</b></td></tr>`;
    });

    const html = `<!doctype html><html><head><meta charset="utf-8">
      <title>Arbeitsbericht</title>
      <style>
        body{font:11px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:18px}
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid #777;padding:4px;text-align:center}
        h3{margin:8px 0 4px}
        @page{size:A4;margin:12mm}
      </style></head><body>
      ${pdfHeader("Arbeitsbericht")}
      <div><b>KW:</b> ${escapeHtml(st.kw)} &nbsp; <b>Zeitraum:</b> ${escapeHtml(st.zr)}</div>
      <div><b>Kunde:</b> ${escapeHtml(c.n||"")} &nbsp; <b>Adresse:</b> ${escapeHtml(c.a||"")}</div>
      <h3>Ausgeführte Arbeit</h3>
      <div>${escapeHtml(c.ag||"").replace(/\n/g,"<br>")}</div>
      <h3>Stunden</h3>
      <table>
        <thead><tr><th>Monteur</th>${head}<th>Woche gesamt</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <script>onload=function(){print()}</script>
      </body></html>`;
    writePrint(html);
  }

  function printWeekly(){
    const grid = st.team.map(() => st.tage.map(() => 0));
    st.k.forEach(c => {
      st.team.forEach((_,r) => {
        st.tage.forEach((_,d) => {
          const v = parseFloat(c.h[r]?.[d] || 0) || 0;
          grid[r][d] += v;
        });
      });
    });

    const head = st.tage.map(t => `<th>${t}</th>`).join("");
    let rows = "";
    st.team.forEach((name,r) => {
      let w = 0;
      let cells = "";
      st.tage.forEach((_,d) => {
        const v = grid[r][d];
        w += v;
        cells += `<td>${v.toFixed(2)}</td>`;
      });
      rows += `<tr><th style="text-align:left">${escapeHtml(name)}</th>${cells}<td><b>${w.toFixed(2)}</b></td></tr>`;
    });

    const html = `<!doctype html><html><head><meta charset="utf-8">
      <title>Wochenbericht</title>
      <style>
        body{font:11px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:18px}
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid #777;padding:4px;text-align:center}
        h3{margin:8px 0 4px}
        @page{size:A4;margin:12mm}
      </style></head><body>
      ${pdfHeader("Wochenbericht (alle Kunden)")}
      <div><b>KW:</b> ${escapeHtml(st.kw)} &nbsp; <b>Zeitraum:</b> ${escapeHtml(st.zr)}</div>
      <h3>Summen je Monteur / Tag</h3>
      <table>
        <thead><tr><th>Monteur</th>${head}<th>Woche gesamt</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <script>onload=function(){print()}</script>
      </body></html>`;
    writePrint(html);
  }

  function printMonteurWeekly(r){
    const name = st.team[r] || `Monteur ${r+1}`;
    const head = st.tage.map(t => `<th>${t}</th>`).join("");
    let cells = "";
    let wsum = 0;

    st.tage.forEach((_,d) => {
      let s = 0;
      st.k.forEach(c => {
        s += parseFloat(c.h[r]?.[d] || 0) || 0;
      });
      wsum += s;
      cells += `<td>${s.toFixed(2)}</td>`;
    });

    const row = `<tr><th style="text-align:left">${escapeHtml(name)}</th>${cells}<td><b>${wsum.toFixed(2)}</b></td></tr>`;

    const html = `<!doctype html><html><head><meta charset="utf-8">
      <title>Wochenbericht Monteur</title>
      <style>
        body{font:11px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:18px}
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid #777;padding:4px;text-align:center}
        h3{margin:8px 0 4px}
        @page{size:A4;margin:12mm}
      </style></head><body>
      ${pdfHeader("Wochenbericht (Monteur) — "+escapeHtml(name))}
      <div><b>KW:</b> ${escapeHtml(st.kw)} &nbsp; <b>Zeitraum:</b> ${escapeHtml(st.zr)}</div>
      <table>
        <thead><tr><th>Monteur</th>${head}<th>Woche gesamt</th></tr></thead>
        <tbody>${row}</tbody>
      </table>
      <script>onload=function(){print()}</script>
      </body></html>`;
    writePrint(html);
  }

  function computeAllVisibleSums(){
    document.querySelectorAll("#kunden tr").forEach(tr => {
      const inputs = tr.querySelectorAll("td.hcell input");
      if(!inputs.length) return;
      let sum = 0;
      inputs.forEach(inp => {
        const v = (inp.value || "").replace(/,/g,".");
        const n = parseFloat(v);
        if(!isNaN(n)) sum += n;
      });
      const last = tr.querySelector("td.sum-cell");
      if(last) last.innerHTML = `<b>${sum.toFixed(2)}</b>`;
    });
  }

  // Init
  (function init(){
    load();
    ensureAtLeastOneKunde();
    render();
  })();

})();
</script>
</body>
</html>
