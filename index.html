<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Welsing Zeiten – v1.7.1 (Excel 1:1 Rapunzel – Hotfix)</title>
<meta name="theme-color" content="#E2231A">
<style>
  :root{--bg:#0b0c10;--card:#15171c;--ink:#fff;--muted:#c7c7c9;--accent:#F28C00;--accent-ink:#1a1300;--primary:#E2231A;--line:#2a2e36;--focus:#FBB040}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.35 system-ui,Segoe UI,Roboto,Arial}
  header{padding:10px 14px;position:sticky;top:0;z-index:9;background:var(--primary);border-bottom:4px solid var(--focus);display:flex;justify-content:space-between;align-items:center}
  .ver{font-size:12px;background:#00000033;border:1px solid #ffffff33;padding:2px 6px;border-radius:8px}
  .wrap{padding:14px}.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.grid{display:grid;gap:10px}.cols2{grid-template-columns:1fr 1fr}@media(max-width:720px){.cols2{grid-template-columns:1fr}}
  label{font-size:13px;color:var(--muted)} input,select,textarea,button{font-size:16px}
  input[type="text"],textarea,select{background:#0f1116;border:1px solid var(--line);border-radius:10px;padding:10px 12px;min-height:44px;width:100%;-webkit-text-fill-color:#fff;color:#fff;caret-color:var(--focus)}
  textarea{min-height:90px} table{border-collapse:collapse;width:100%;background:#0f1116;border-radius:10px;overflow:hidden}
  th,td{border:1px solid var(--line);padding:8px;text-align:center} thead th{background:var(--focus);color:#000;font-weight:800}
  .btn{background:var(--accent);color:#1a1300;border:0;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer;min-height:44px}
  .btn.secondary{background:transparent;color:#fff;border:2px solid var(--accent)}
  .pill{display:inline-block;background:#0f1116;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px}
  .footer{position:sticky;bottom:0;background:#0f1116;border-top:3px solid var(--primary);padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap;z-index:9}
  .footer>*{flex:1 1 48%} iframe#printFrame{position:fixed;left:-9999px;top:-9999px;width:0;height:0;border:0}
  .hcell input{-webkit-appearance:none;appearance:none;color:rgba(255,255,255,0.999)!important;-webkit-text-fill-color:#fff!important;background:#0f1116!important;caret-color:#FBB040;opacity:1!important;text-shadow:none!important;text-align:center;font-size:18px;font-weight:600}
  .hcell input::placeholder{color:#6a6a6a}
</style>
</head>
<body>
<header>
  <b>Welsing Zeiten</b>
  <div class="ver">v1.7.1 – Excel 1:1 Rapunzel (Hotfix)</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="grid cols2">
      <div><label>KW</label><input id="kw" type="text" placeholder="z. B. KW 42"></div>
      <div><label>Zeitraum</label><input id="zr" type="text" placeholder="z. B. 13.10.–18.10.2025"></div>
    </div>
    <div class="grid cols2">
      <div><label>Monteur-Team (Komma)</label><input id="team" type="text" placeholder="z. B. Kevin, Jacub, Mario"></div>
      <div><label>Sonntag</label><select id="sun"><option value="0">aus</option><option value="1">an</option></select></div>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnWeeklyAll">Wochenbericht (alle) PDF</button>
      <select id="selMonteur" title="Monteur wählen"></select>
      <button class="btn secondary" id="btnWeeklyMonteur">PDF (Wochenbericht Monteur)</button>
      <button class="btn secondary" id="btnWipe">Daten zurücksetzen</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <button class="btn secondary" id="btnAddK">+ Kunde</button>
      <button class="btn secondary" id="btnRemK">− Kunde</button>
      <select id="sel"></select>
      <button class="btn" id="btnScroll">Zu Kunde</button>
    </div>
    <div id="kunden"></div>
  </div>
</div>

<div class="footer">
  <select id="sel2"></select>
  <button class="btn secondary" id="btnScroll2">Zu Kunde</button>
  <button class="btn" id="btnPdfArbeitsbericht">PDF (Arbeitsbericht Kunde)</button>
</div>
<iframe id="printFrame"></iframe>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>

<script>
(function(){
var st = {kw:"", zr:"", tage:["Mo","Di","Mi","Do","Fr","Sa"], team:["Kevin","Jacub","Mario","Martin","Tomas"], k:[]};
var KEY="wz_v171_excel_rapunzel"; var lastSel = 0; var templateBinary=null;

try{ var usp = new URLSearchParams(location.search); if (usp.get('wipe')==='1'){ localStorage.clear(); } }catch(e){}

function save(){ try{ localStorage.setItem(KEY, JSON.stringify(st)); }catch(e){} }
function load(){ try{ var raw=localStorage.getItem(KEY); if(raw){ var o=JSON.parse(raw)||{}; if(o && typeof o==='object') st=Object.assign(st,o); } }catch(e){} }

function newK(){ return {n:"", a:"", az:"", ag:"", h: st.team.map(function(){return st.tage.map(function(){return ""})}), m:[{b:"",s:"",r:""}]}; }
function addKunde(){ st.k.push(newK()); render(); setSel(st.k.length-1); save(); }
function remKunde(){ if(st.k.length<=1){alert("Mindestens 1 Kunde.");return} var i=lastSel; st.k.splice(i,1); render(); if(i>=st.k.length)i=st.k.length-1; setSel(i); save(); }

function setSel(v){ lastSel=parseInt(v||"0",10)||0; document.getElementById('sel').value=String(lastSel); document.getElementById('sel2').value=String(lastSel); }
function scrollSel(){ var el=document.getElementById('k'+lastSel); if(el){ el.scrollIntoView({behavior:'smooth'}); } }

function toggleSun(v){ if(v==="1"){ if(st.tage.indexOf("So")<0) st.tage.push("So"); } else { st.tage=st.tage.filter(function(t){return t!=="So"}); } fixShapes(); render(); save(); }
function applyTeam(){ var arr=document.getElementById('team').value.split(',').map(function(s){return s.trim()}).filter(Boolean); if(arr.length){ st.team=arr; fixShapes(); render(); save(); } }

function fixShapes(){
  for(var i=0;i<st.k.length;i++){
    var c=st.k[i];
    while(c.h.length<st.team.length) c.h.push(st.tage.map(function(){return ""}));
    while(c.h.length>st.team.length) c.h.pop();
    for(var r=0;r<c.h.length;r++){
      while(c.h[r].length<st.tage.length) c.h[r].push("");
      while(c.h[r].length>st.tage.length) c.h[r].pop();
    }
  }
}

function sanitizeDec(s){
  s = (s||"").toString().replace(/,/g,".").replace(/[^0-9.]/g,"");
  var p = s.indexOf('.'); if(p>=0){ s = s.slice(0,p+1) + s.slice(p+1).replace(/\./g,""); }
  return s;
}

function setH(i,r,d,v){
  v = sanitizeDec(v);
  st.k[i].h[r][d] = v;
  save();
  renderRowSum(i,r);
  renderLists();
}

function setF(i,f,v){ st.k[i][f]=v; save(); renderLists(); }
function addM(i){ st.k[i].m.push({b:"",s:"",r:""}); save(); render(); }
function delM(i,m){ st.k[i].m.splice(m,1); save(); render(); }
function setM(i,m,f,v){ st.k[i].m[m][f]=v; save(); }

function render(){
  fixShapes();
  document.getElementById('kw').value = st.kw;
  document.getElementById('zr').value = st.zr;
  document.getElementById('sun').value = st.tage.indexOf("So")>=0 ? "1":"0";
  document.getElementById('team').value = st.team.join(', ');

  var monOpts = st.team.map(function(n,idx){ return '<option value="'+idx+'">'+escapeHtml(n)+'</option>'; }).join('');
  document.getElementById('selMonteur').innerHTML = monOpts;

  var opts=''; for(var i=0;i<st.k.length;i++){ opts+='<option value="'+i+'">'+String(i+1).padStart(2,'0')+' — '+(st.k[i].n||'Kunde')+'</option>'; }
  if(!opts){ st.k=[newK()]; opts='<option value="0">01 — Kunde</option>'; }
  document.getElementById('sel').innerHTML=opts; document.getElementById('sel2').innerHTML=opts;

  var out=''; for(var i=0;i<st.k.length;i++){ out += card(i); }
  document.getElementById('kunden').innerHTML = out;

  renderLists();
  setSel(lastSel);

  attachDelegates();
  setTimeout(computeAllVisibleSums,0);
}

function renderRowSum(i,r){
  var card = document.getElementById('k'+i); if(!card) return;
  var tr = card.querySelector('tr[data-r="'+r+'"]'); if(!tr) return;
  var inputs = tr.querySelectorAll('td.hcell input');
  var sum = 0;
  inputs.forEach(function(inp){
    var v = inp.value.replace(/,/g,'.');
    var n = parseFloat(v);
    if(!isNaN(n)) sum += n;
  });
  var last = tr.querySelector('td.sum-cell');
  if(last) last.innerHTML = '<b>'+sum.toFixed(2)+'</b>';
}

function renderLists(){
  var grid = st.team.map(function(){ return st.tage.map(function(){ return 0; }); });
  for(var k=0;k<st.k.length;k++){
    for(var r=0;r<st.team.length;r++){
      for(var d=0; d<st.tage.length; d++){
        var v = parseFloat(st.k[k].h[r][d]||0)||0;
        grid[r][d]+=v;
      }
    }
  }
  // HOTFIX: fehlende Klammer war der Bug
  var th = st.tage.map(function(t){return '<th>'+t+'</th>';}).join('');
  var rows='';
  for(var r=0;r<st.team.length;r++){
    var w=0, cells='';
    for(var d=0;d<st.tage.length;d++){ cells+='<td>'+grid[r][d].toFixed(2)+'</td>'; w+=grid[r][d]; }
    rows+='<tr><th style="text-align:left)">'+escapeHtml(st.team[r])+'</th>'+cells+'<td><b>'+w.toFixed(2)+'</b></td></tr>';
  }
  var el = document.getElementById('overview');
  if(el){ el.innerHTML = '<table><thead><tr><th>Monteur</th>'+th+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table>'; }
}

function card(i){
  var c=st.k[i];
  var rows='';
  for(var r=0;r<st.team.length;r++){
    rows+='<tr data-r="'+r+'"><th style="text-align:left)">'+escapeHtml(st.team[r])+'</th>';
    for(var d=0;d<st.tage.length;d++){
      var v=c.h[r][d]||'';
      rows+='<td class="hcell"><input type="tel" inputmode="decimal" placeholder="0" value="'+v+'" data-i="'+i+'" data-r="'+r+'" data-d="'+d+'"></td>';
    }
    rows+='<td class="sum-cell"><b>0.00</b></td></tr>';
  }
  var mats='';
  for(var m=0;m<c.m.length;m++){
    var it=c.m[m];
    mats+='<tr><td><input type="text" value="'+escapeAttr(it.b)+'" data-i="'+i+'" data-m="'+m+'" data-f="b"></td>'+
          '<td><input type="text" value="'+escapeAttr(it.s)+'" data-i="'+i+'" data-m="'+m+'" data-f="s"></td>'+
          '<td><input type="text" value="'+escapeAttr(it.r)+'" data-i="'+i+'" data-m="'+m+'" data-f="r"></td>'+
          '<td><button class="btn secondary" data-action="delM" data-i="'+i+'" data-m="'+m+'">−</button></td></tr>';
  }
  if(!mats) mats = '<tr><td colspan="4" style="text-align:center;color:#666">—</td></tr>';
  return '<div class="card" id="k'+i+'">'+
    '<div class="row"><span class="pill">Kunde '+String(i+1).padStart(2,"0")+'</span>'+
    '<button class="btn" data-action="printK" data-i="'+i+'" style="margin-left:auto">PDF Arbeitsbericht</button>'+
    '<button class="btn secondary" data-action="printRapunzelLeft" data-i="'+i+'">PDF Rapunzel (links)</button>'+
    '<button class="btn" data-action="excelRapunzel" data-i="'+i+'">Excel Rapunzel (1:1)</button>'+
    '</div>'+
    '<div class="grid cols2" style="margin-top:6px">'+
      '<div><label>Name (AG)</label><input type="text" value="'+escapeAttr(c.n)+'" data-action="setF" data-i="'+i+'" data-f="n"></div>'+
      '<div><label>Adresse</label><input type="text" value="'+escapeAttr(c.a)+'" data-action="setF" data-i="'+i+'" data-f="a"></div>'+
    '</div>'+
    '<div class="grid cols2" style="margin-top:6px">'+
      '<div><label>Auszuführende Arbeit (Beschreibung)</label><textarea data-action="setF" data-i="'+i+'" data-f="az">'+escapeHtml(c.az)+'</textarea></div>'+
      '<div><label>Ausgeführte Arbeit</label><textarea data-action="setF" data-i="'+i+'" data-f="ag">'+escapeHtml(c.ag)+'</textarea></div>'+
    '</div>'+
    '<div style="margin-top:8px"><b>Stunden</b><table><thead><tr><th>Monteur</th>'+st.tage.map(function(t){return '<th>'+t+'</th>'}).join('')+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table></div>'+
    '<div style="margin-top:8px"><b>Materialverbrauch</b> <button class="btn secondary" data-action="addM" data-i="'+i+'">+ Material</button>'+
      '<table style="margin-top:6px"><thead><tr><th>Material</th><th>Stückzahl</th><th>Bemerkung</th><th></th></tr></thead><tbody>'+mats+'</tbody></table></div>'+
  '</div>';
}

function attachDelegates(){
  document.getElementById('kw').oninput = function(){ st.kw=this.value; save(); };
  document.getElementById('zr').oninput = function(){ st.zr=this.value; save(); };
  document.getElementById('sun').onchange = function(){ toggleSun(this.value); };
  document.getElementById('team').onchange = function(){ applyTeam(); };
  document.getElementById('btnWeeklyAll').onclick = printWeekly;
  document.getElementById('btnWeeklyMonteur').onclick = function(){
    var sel = document.getElementById('selMonteur'); var r = parseInt(sel.value||"0",10)||0;
    printMonteurWeekly(r);
  };
  document.getElementById('btnWipe').onclick = function(){ try{ localStorage.clear(); }catch(e){} location.href='?wipe=1&cb='+(Date.now()); };

  document.getElementById('btnAddK').onclick = addKunde;
  document.getElementById('btnRemK').onclick = remKunde;
  document.getElementById('sel').onchange = function(){ setSel(this.value); };
  document.getElementById('btnScroll').onclick = scrollSel;

  document.getElementById('sel2').onchange = function(){ setSel(this.value); };
  document.getElementById('btnScroll2').onclick = scrollSel;
  document.getElementById('btnPdfArbeitsbericht').onclick = function(){ printK(lastSel); };

  var kc = document.getElementById('kunden');
  kc.addEventListener('input', function(e){
    var t=e.target;
    if(t.matches('td.hcell input')){
      var i=+t.dataset.i, r=+t.dataset.r, d=+t.dataset.d;
      setH(i,r,d,t.value); return;
    }
    if(t.matches('[data-action="setF"]')){
      var i=+t.dataset.i, f=t.dataset.f;
      setF(i,f,t.value); return;
    }
    if(t.matches('input[data-f], textarea[data-f]')){
      var i=+t.dataset.i, f=t.dataset.f, m=+t.dataset.m;
      setM(i,m,f,t.value); return;
    }
  });
  kc.addEventListener('click', function(e){
    var b=e.target.closest('button[data-action]'); if(!b) return;
    var act=b.dataset.action, i=+b.dataset.i;
    if(act==="addM") addM(i);
    else if(act==="delM"){ var m=+b.dataset.m; delM(i,m); }
    else if(act==="printK") printK(i);
    else if(act==="printRapunzelLeft") printRapunzelLeft(i);
    else if(act==="excelRapunzel") excelRapunzel(i);
  });
}

function computeAllVisibleSums(){
  document.querySelectorAll('#kunden tr').forEach(function(tr){
    var inputs = tr.querySelectorAll('td.hcell input');
    var sum = 0;
    inputs.forEach(function(inp){
      var v = (inp.value||'').replace(/,/g,'.');
      var n = parseFloat(v);
      if(!isNaN(n)) sum += n;
    });
    var last = tr.querySelector('td.sum-cell');
    if (last){ last.innerHTML = '<b>'+sum.toFixed(2)+'</b>'; }
  });
}

function pdfHeader(title){ return '<div style="margin-bottom:4px;font-weight:700">'+title+'</div>'; }

/*** PDF-Methoden ***/
function writePrint(html){
  var fr=document.getElementById('printFrame');
  var doc = fr.contentWindow || fr.contentDocument;
  if(doc.document) doc = doc.document;
  doc.open(); doc.write(html); doc.close();
}
function escapeHtml(s){ return (s||'').toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function escapeAttr(s){ return (s||'').toString().replace(/&/g,"&amp;").replace(/"/g,"&quot;"); }

function printK(i){
  var c=st.k[i]; var head=st.tage.map(function(t){return '<th>'+t+'</th>'}).join(''); var rows='';
  for(var r=0;r<st.team.length;r++){ var sum=0, cells=''; for(var d=0;d<st.tage.length;d++){ var n=parseFloat(c.h[r][d]||0)||0; sum+=n; cells+='<td>'+n.toFixed(2)+'</td>'; } rows+='<tr><th style="text-align:left)">'+escapeHtml(st.team[r])+'</th>'+cells+'<td><b>'+sum.toFixed(2)+'</b></td></tr>'; }
  var html='<!doctype html><html><head><meta charset="utf-8"><title>Arbeitsbericht</title><style>body{font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #777;padding:6px;text-align:center}@page{size:A4;margin:15mm}</style></head><body>'
  + pdfHeader('Arbeitsbericht') + '<div style="margin-bottom:6px"><b>KW:</b> '+escapeHtml(st.kw)+' &nbsp; <b>Zeitraum:</b> '+escapeHtml(st.zr)+'</div>'
  + '<div style="margin-bottom:6px"><b>Kunde:</b> '+escapeHtml(c.n||"")+' — <b>Adresse:</b> '+escapeHtml(c.a||"")+'</div>'
  + '<h3>Ausgeführte Arbeit</h3><div>'+escapeHtml((c.ag||"")).replace(/\n/g,"<br>")+'</div>'
  + '<h3>Stunden</h3><table><thead><tr><th>Monteur</th>'+head+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table>'
  + '<script>onload=function(){print()}</'+'script></body></html>'; writePrint(html);
}

function printMonteurWeekly(r){
  var name = st.team[r] || ('Monteur '+(r+1)); var head = st.tage.map(function(t){return '<th>'+t+'</th>';}).join('');
  var cells='', wsum=0; for(var d=0; d<st.tage.length; d++){ var s=0; for(var k=0; k<st.k.length; k++){ s += parseFloat(st.k[k].h[r] ? (st.k[k].h[r][d]||0) : 0) || 0; } wsum += s; cells += '<td>'+s.toFixed(2)+'</td>'; }
  var rowsSum = '<tr><th style="text-align:left)">'+escapeHtml(name)+'</th>'+cells+'<td><b>'+wsum.toFixed(2)+'</b></td></tr>';
  var html='<!doctype html><html><head><meta charset="utf-8"><title>Wochenbericht (Monteur)</title><style>body{font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #777;padding:6px;text-align:center}@page{size:A4;margin:15mm}</style></head><body>'
  + pdfHeader('Wochenbericht (Monteur) — '+escapeHtml(name))
  + '<div style="margin-bottom:6px"><b>KW:</b> '+escapeHtml(st.kw)+' &nbsp; <b>Zeitraum:</b> '+escapeHtml(st.zr)+'</div>'
  + '<table><thead><tr><th>Monteur</th>'+head+'<th>Woche gesamt</th></tr></thead><tbody>'+rowsSum+'</tbody></table>'
  + '<script>onload=function(){print()}</'+'script></body></html>'; writePrint(html);
}

function printRapunzelLeft(i){
  var c=st.k[i]; var days=["Mo","Di","Mi","Do","Fr","Sa"]; var cols=st.team.slice(); // automatische Namen
  var thead='<tr><th style="background:#CFE2F3;border:1px solid #777;padding:6px">Tag</th>'+cols.map(function(n){return '<th style="background:#CFE2F3;border:1px solid #777;padding:6px">'+escapeHtml(n)+'</th>').join('')+'<th style="background:#CFE2F3;border:1px solid #777;padding:6px">Summe</th><th style="background:#CFE2F3;border:1px solid #777;padding:6px;text-align:left">Tätigkeiten</th></tr>';
  var tbody=''; for(var d=0; d<days.length; d++){ var sum=0, cells=''; for(var r=0;r<cols.length;r++){ var idx=r; var h=parseFloat(c.h[idx] ? (c.h[idx][d]||0) : 0)||0; sum+=h; cells+='<td style="border:1px solid #777;padding:6px">'+h.toFixed(2)+'</td>'; } tbody+='<tr><td style="border:1px solid #777;padding:6px"><b>'+days[d]+'</b></td>'+cells+'<td style="border:1px solid #777;padding:6px"><b>'+sum.toFixed(2)+'</b></td><td style="border:1px solid #777;padding:6px;text-align:left">'+escapeHtml(c.ag||"")+'</td></tr>'; }
  var html='<!doctype html><html><head><meta charset="utf-8"><title>Regiebericht (links)</title><style>body{font:12px/1.35 system-ui,Segoe UI,Roboto,Arial;padding:14px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #777;padding:6px;text-align:center}@page{size:A4 landscape;margin:10mm}</style></head><body>'
  + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-size:16px;font-weight:700">Regiebericht Welsing</div><div><b>KW:</b> '+escapeHtml(st.kw)+' &nbsp; <b>Zeitraum:</b> '+escapeHtml(st.zr)+'</div></div>'
  + '<div style="margin:4px 0"><b>AG:</b> '+escapeHtml(c.n||"")+'</div>'
  + '<div style="margin:4px 0"><b>Beschreibung:</b> '+escapeHtml(c.az||"")+'</div>'
  + '<table><thead>'+thead+'</thead><tbody>'+tbody+'</tbody></table>'
  + '<script>onload=function(){print()}</'+'script></body></html>';
  writePrint(html);
}

/*** Excel (1:1) – export mit Vorlage ***/
function askTemplateThen(cb){
  if(templateBinary){ cb(templateBinary); return; }
  var inp = document.createElement('input');
  inp.type='file'; inp.accept='.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
  inp.onchange=function(){
    var f=inp.files[0]; if(!f){alert('Keine Datei gewählt.');return;}
    var reader=new FileReader();
    reader.onload=function(e){ templateBinary=e.target.result; cb(templateBinary); };
    reader.readAsArrayBuffer(f);
  };
  inp.click();
}

function excelRapunzel(i){
  askTemplateThen(function(bin){
    try{
      var wb = XLSX.read(bin, {type:'array'});
      var wsname = wb.SheetNames[0];
      var ws = wb.Sheets[wsname];

      function findCell(text){
        var range = XLSX.utils.decode_range(ws['!ref']);
        for(var R=range.s.r; R<=range.e.r; ++R){
          for(var C=range.s.c; C<=range.e.c; ++C){
            var addr = XLSX.utils.encode_cell({r:R,c:C});
            var cell = ws[addr]; if(!cell) continue;
            var v = (cell.v==null?'':String(cell.v)).trim();
            if(v === text) return {r:R,c:C,addr:addr};
          }
        }
        return null;
      }
      function write(addr, value){ ws[addr] = {t:'s', v: String(value)}; }

      var c = st.k[i];

      var kwLbl = findCell('KW'); if(kwLbl){ var kwCell = XLSX.utils.encode_cell({r:kwLbl.r, c:kwLbl.c+1}); write(kwCell, st.kw||''); }
      var agLbl = findCell('AG'); if(agLbl){ var agCell = XLSX.utils.encode_cell({r:agLbl.r, c:agLbl.c+1}); write(agCell, c.n||''); }
      var beschLbl = findCell('Beschreibung'); if(beschLbl){ var beschCell = XLSX.utils.encode_cell({r:beschLbl.r, c:beschLbl.c+1}); write(beschCell, c.az||''); }

      var tagRows = {}; var tage = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Mo','Di','Mi','Do','Fr','Sa'];
      var range = XLSX.utils.decode_range(ws['!ref']);
      for(var R=range.s.r; R<=range.e.r; ++R){
        var a = XLSX.utils.encode_cell({r:R,c:range.s.c});
        var v = ws[a] && ws[a].v ? String(ws[a].v).trim() : '';
        if(tage.indexOf(v)>=0){ tagRows[v] = R; }
      }
      var dayMap = {}; [['Mo','Montag'],['Di','Dienstag'],['Mi','Mittwoch'],['Do','Donnerstag'],['Fr','Freitag'],['Sa','Samstag']].forEach(function(p){ var r = (tagRows[p[0]]!=null?tagRows[p[0]]:tagRows[p[1]]); if(r!=null) dayMap[p[0]]=r; });

      var firstDayRow = null; for(var k in dayMap){ if(firstDayRow==null || dayMap[k]<firstDayRow) firstDayRow = dayMap[k]; }
      if(firstDayRow==null){ alert('Konnte die Tageszeilen in der Excel nicht finden.'); return; }
      var headerRow = firstDayRow-1;

      var Cstart = 1; var Cend = range.e.c;
      for(var C=Cstart; C<=range.e.c; ++C){
        var addr = XLSX.utils.encode_cell({r:headerRow, c:C});
        var v = ws[addr] && ws[addr].v ? String(ws[addr].v).toLowerCase() : '';
        if(v.includes('summe')){ Cend = C-1; break; }
      }

      var names = st.team.slice(0, Math.max(0, Cend-Cstart+1));
      for(var idx=0; idx<names.length; idx++){
        var haddr = XLSX.utils.encode_cell({r:headerRow, c:Cstart+idx});
        write(haddr, names[idx]);
      }

      function hours(nameIdx, dayIdx){ var v = parseFloat(c.h[nameIdx] ? (c.h[nameIdx][dayIdx]||0) : 0) || 0; return v; }
      var dayOrder=['Mo','Di','Mi','Do','Fr','Sa'];
      for(var d=0; d<dayOrder.length; d++){
        var Rrow = dayMap[dayOrder[d]]; if(Rrow==null) continue;
        for(var n=0; n<names.length; n++){
          var addr = XLSX.utils.encode_cell({r:Rrow, c:Cstart+n});
          var v = hours(n, d);
          ws[addr] = {t:'n', v:v};
        }
        var actAddr = XLSX.utils.encode_cell({r:Rrow, c:Cend+2});
        write(actAddr, c.ag||'');
      }

      var outwb = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      var blob = new Blob([outwb], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      var safeName = (c.n || 'Kunde').replace(/[^\w\s-]+/g,'_').slice(0,40);
      a.download = 'Regiebericht_Rapunzel_'+ safeName + '.xlsx';
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); }, 2000);
    }catch(err){
      console.error(err);
      alert('Excel-Export fehlgeschlagen: ' + err.message);
    }
  });
}

function printWeekly(){
  var grid = st.team.map(function(){ return st.tage.map(function(){ return 0; }); });
  for(var k=0;k<st.k.length;k++){ for(var r=0;r<st.team.length;r++){ for(var d=0; d<st.tage.length; d++){ var v=parseFloat(st.k[k].h[r][d]||0)||0; grid[r][d]+=v; } } }
  var head=st.tage.map(function(t){return '<th>'+t+'</th>';}).join('');
  var rows='';
  for(var r=0;r<st.team.length;r++){ var w=0,cells=''; for(var d=0; d<st.tage.length; d++){ w+=grid[r][d]; cells+='<td>'+grid[r][d].toFixed(2)+'</td>'; } rows+='<tr><th style="text-align:left)">'+escapeHtml(st.team[r])+'</th>'+cells+'<td><b>'+w.toFixed(2)+'</b></td></tr>'; }
  var html='<!doctype html><html><head><meta charset="utf-8"><title>Wochenbericht</title><style>body{font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #777;padding:6px;text-align:center}@page{size:A4;margin:15mm}</style></head><body>'
    + pdfHeader('Wochenbericht (alle Kunden)')
    + '<div style="margin-bottom:6px"><b>KW:</b> '+escapeHtml(st.kw)+' &nbsp; <b>Zeitraum:</b> '+escapeHtml(st.zr)+'</div>'
    + '<h3>Summen je Monteur / Tag</h3><table><thead><tr><th>Monteur</th>'+head+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table>'
    + '<script>onload=function(){print()}</'+'script></body></html>';
  writePrint(html);
}

// init
load();
if(!st.k || !Array.isArray(st.k) || st.k.length===0){ st.k=[newK()]; }
render();
attachDelegates();
})();
</script>
</body>
</html>
