<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Welsing Zeiten – v1.6.3 MOBILEFIX+</title>
<meta name="theme-color" content="#E2231A">
<style>
  :root{--bg:#0b0c10;--card:#15171c;--ink:#fff;--muted:#c7c7c9;--accent:#F28C00;--accent-ink:#1a1300;--primary:#E2231A;--line:#2a2e36;--focus:#FBB040}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.35 system-ui,Segoe UI,Roboto,Arial}
  header{padding:10px 14px;position:sticky;top:0;z-index:9;background:var(--primary);border-bottom:4px solid var(--focus);display:flex;justify-content:space-between;align-items:center}
  .ver{font-size:12px;background:#00000033;border:1px solid #ffffff33;padding:2px 6px;border-radius:8px}
  .wrap{padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:10px}.cols2{grid-template-columns:1fr 1fr}@media(max-width:720px){.cols2{grid-template-columns:1fr}}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea,button{font-size:16px}
  input[type="text"],textarea,select{background:#0f1116;border:1px solid var(--line);border-radius:10px;padding:10px 12px;min-height:44px;width:100%;-webkit-text-fill-color:#fff;color:#fff;caret-color:var(--focus)}
  textarea{min-height:90px}
  table{border-collapse:collapse;width:100%;background:#0f1116;border-radius:10px;overflow:hidden}
  th,td{border:1px solid var(--line);padding:8px;text-align:center}
  thead th{background:var(--focus);color:#000;font-weight:800}
  .btn{background:var(--accent);color:#1a1300;border:0;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer;min-height:44px}
  .btn.secondary{background:transparent;color:#fff;border:2px solid var(--accent)}
  .pill{display:inline-block;background:#0f1116;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px}
  .footer{position:sticky;bottom:0;background:#0f1116;border-top:3px solid var(--primary);padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap;z-index:9}
  .footer>*{flex:1 1 48%}
  iframe#printFrame{position:fixed;left:-9999px;top:-9999px;width:0;height:0;border:0}
  .hcell input{ text-align:center; font-size:18px; font-weight:600; color:#fff !important; -webkit-text-fill-color:#fff !important; background:#0f1116 !important; opacity: 1 !important; }
  input:-webkit-autofill,
  input:-webkit-autofill:hover,
  input:-webkit-autofill:focus{ -webkit-text-fill-color:#fff !important; box-shadow:0 0 0px 1000px #0f1116 inset !important; }
/* --- MOBILE VISIBILITY HOTFIX --- */
.hcell input{
  color:#fff !important;
  -webkit-text-fill-color:#fff !important;
  background:#0f1116 !important;
  text-shadow:0 0 0 #fff;          /* zwingt Repaint */
  opacity:1 !important;
  transform:translateZ(0);          /* eigene Compositor-Layer */
  will-change:transform;
  caret-color:#FBB040;              /* sichtbarer Cursor */
}
input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus{
  -webkit-text-fill-color:#fff !important;
  box-shadow:0 0 0px 1000px #0f1116 inset !important;
}
</style>
</head>
<body>
<header>
  <b>Welsing Zeiten</b>
  <div class="ver">v1.6.3 MOBILEFIX+</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="grid cols2">
      <div><label>KW</label><input id="kw" type="text" placeholder="z. B. KW 42"></div>
      <div><label>Zeitraum</label><input id="zr" type="text" placeholder="z. B. 13.10.–18.10.2025"></div>
    </div>
    <div class="grid cols2">
      <div><label>Monteur-Team (Komma)</label><input id="team" type="text" placeholder="z. B. Kevin, Jacub, Mario"></div>
      <div><label>Sonntag</label>
        <select id="sun"><option value="0">aus</option><option value="1">an</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="btn secondary" id="btnApplyTeam">Team übernehmen</button>
      <button class="btn" id="btnWeeklyAll">Wochenbericht (alle) PDF</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <button class="btn secondary" id="btnAddK">+ Kunde</button>
      <button class="btn secondary" id="btnRemK">− Kunde</button>
      <select id="sel"></select>
      <button class="btn" id="btnScroll">Zu Kunde</button>
    </div>
    <div id="kunden"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;width:100%">
      <b>Wochenübersicht (Summe je Monteur & Tag)</b>
      <span style="color:#bbb">zum Nachschauen</span>
    </div>
    <div id="overview"></div>
  </div>
</div>

<div class="footer">
  <select id="sel2"></select>
  <button class="btn secondary" id="btnScroll2">Zu Kunde</button>
  <button class="btn" id="btnPdfArbeitsbericht">PDF (Arbeitsbericht Kunde)</button>
  <button class="btn" id="btnPdfWochenKunde">PDF (Wochenbericht Kunde)</button>
</div>
<iframe id="printFrame"></iframe>

<script>
(function(){
var st = {kw:"", zr:"", tage:["Mo","Di","Mi","Do","Fr","Sa"], team:["Kevin","Jacub","Mario","Martin","Tomas"], k:[]};
var KEY="wz_v163"; var lastSel = 0;
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(st)); }catch(e){} }
function load(){ try{ var raw=localStorage.getItem(KEY); if(raw) st=JSON.parse(raw); }catch(e){} }

function newK(){ return {n:"", a:"", az:"", ag:"", h: st.team.map(function(){return st.tage.map(function(){return ""})}), m:[{b:"",s:"",r:""}]}; }
function addKunde(){ st.k.push(newK()); render(); setSel(st.k.length-1); save(); if(window._afterRenderPatch) _afterRenderPatch(); }
function remKunde(){ if(st.k.length<=1){alert("Mindestens 1 Kunde.");return} var i=lastSel; st.k.splice(i,1); render(); if(i>=st.k.length)i=st.k.length-1; setSel(i); save(); if(window._afterRenderPatch) _afterRenderPatch(); }
function setSel(v){ lastSel=parseInt(v||"0",10)||0; document.getElementById('sel').value=String(lastSel); document.getElementById('sel2').value=String(lastSel); }
function scrollSel(){ var el=document.getElementById('k'+lastSel); if(el){ el.scrollIntoView({behavior:'smooth'}); } }

function toggleSun(v){ if(v==="1"){ if(st.tage.indexOf("So")<0) st.tage.push("So"); } else { st.tage=st.tage.filter(function(t){return t!=="So"}); } fixShapes(); render(); save(); if(window._afterRenderPatch) _afterRenderPatch(); }
function applyTeam(){ var arr=document.getElementById('team').value.split(',').map(function(s){return s.trim()}).filter(Boolean); if(arr.length){ st.team=arr; fixShapes(); render(); save(); if(window._afterRenderPatch) _afterRenderPatch(); } }

function fixShapes(){
  for(var i=0;i<st.k.length;i++){
    var c=st.k[i];
    while(c.h.length<st.team.length) c.h.push(st.tage.map(function(){return ""}));
    while(c.h.length>st.team.length) c.h.pop();
    for(var r=0;r<c.h.length;r++){
      while(c.h[r].length<st.tage.length) c.h[r].push("");
      while(c.h[r].length>st.tage.length) c.h[r].pop();
    }
  }
}

function sanitizeDec(s){
  s = (s||"").toString();
  s = s.replace(/,/g,".");      // Komma -> Punkt
  s = s.replace(/[^0-9.]/g,""); // nur Ziffern und Punkt
  var p = s.indexOf('.'); if(p>=0){ s = s.slice(0,p+1) + s.slice(p+1).replace(/\\./g,""); } // nur 1 Punkt
  return s;
}

function setH(i,r,d,v){
  v = sanitizeDec(v);
  st.k[i].h[r][d] = v;
  save();
  renderRowSum(i,r);
  renderLists();
}

function setF(i,f,v){ st.k[i][f]=v; save(); renderLists(); }
function addM(i){ st.k[i].m.push({b:"",s:"",r:""}); save(); render(); if(window._afterRenderPatch) _afterRenderPatch(); }
function delM(i,m){ st.k[i].m.splice(m,1); save(); render(); if(window._afterRenderPatch) _afterRenderPatch(); }
function setM(i,m,f,v){ st.k[i].m[m][f]=v; save(); }

function render(){
  fixShapes();
  document.getElementById('kw').value = st.kw;
  document.getElementById('zr').value = st.zr;
  document.getElementById('sun').value = st.tage.indexOf("So")>=0 ? "1":"0";
  document.getElementById('team').value = st.team.join(', ');

  var opts=''; for(var i=0;i<st.k.length;i++){ opts+='<option value="'+i+'">'+String(i+1).padStart(2,'0')+' — '+(st.k[i].n||'Kunde')+'</option>'; }
  document.getElementById('sel').innerHTML=opts; document.getElementById('sel2').innerHTML=opts;

  var out='';
  for(var i=0;i<st.k.length;i++){ out += card(i); }
  document.getElementById('kunden').innerHTML = out;

  renderLists();
  setSel(lastSel);

  attachDelegates();
  setTimeout(computeAllVisibleSums,0);
}

function renderRowSum(i,r){
  var card = document.getElementById('k'+i);
  if(!card) return;
  var tr = card.querySelector('tr[data-r="'+r+'"]');
  if(!tr) return;
  var inputs = tr.querySelectorAll('td.hcell input');
  var sum = 0;
  inputs.forEach(function(inp){
    var v = inp.value.replace(/,/g,'.');
    var n = parseFloat(v);
    if(!isNaN(n)) sum += n;
  });
  var last = tr.querySelector('td.sum-cell');
  if(last) last.innerHTML = '<b>'+sum.toFixed(2)+'</b>';
}

function renderLists(){
  var grid = st.team.map(function(){ return st.tage.map(function(){ return 0; }); });
  for(var k=0;k<st.k.length;k++){
    for(var r=0;r<st.team.length;r++){
      for(var d=0; d<st.tage.length; d++){
        var v = parseFloat(st.k[k].h[r][d]||0)||0;
        grid[r][d]+=v;
      }
    }
  }
  var th = st.tage.map(function(t){return '<th>'+t+'</th>'}).join('');
  var rows='';
  for(var r=0;r<st.team.length;r++){
    var w=0, cells='';
    for(var d=0;d<st.tage.length;d++){ cells+='<td>'+grid[r][d].toFixed(2)+'</td>'; w+=grid[r][d]; }
    rows+='<tr><th style="text-align:left">'+esc(st.team[r])+'</th>'+cells+'<td><b>'+w.toFixed(2)+'</b></td></tr>';
  }
  document.getElementById('overview').innerHTML = '<table><thead><tr><th>Monteur</th>'+th+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table>';
}

function card(i){
  var c=st.k[i];
  var rows='';
  for(var r=0;r<st.team.length;r++){
    rows+='<tr data-r="'+r+'"><th style="text-align:left">'+esc(st.team[r])+'</th>';
    for(var d=0;d<st.tage.length;d++){
      var v=c.h[r][d]||'';
      rows+='<td class="hcell"><input type="text" inputmode="decimal" placeholder="0" value="'+v+'" data-i="'+i+'" data-r="'+r+'" data-d="'+d+'"></td>';
    }
    rows+='<td class="sum-cell"><b>0.00</b></td></tr>';
  }
  var mats='';
  for(var m=0;m<c.m.length;m++){
    var it=c.m[m];
    mats+='<tr><td><input type="text" value="'+escAttr(it.b)+'" data-i="'+i+'" data-m="'+m+'" data-f="b"></td>'+
          '<td><input type="text" value="'+escAttr(it.s)+'" data-i="'+i+'" data-m="'+m+'" data-f="s"></td>'+
          '<td><input type="text" value="'+escAttr(it.r)+'" data-i="'+i+'" data-m="'+m+'" data-f="r"></td>'+
          '<td><button class="btn secondary" data-action="delM" data-i="'+i+'" data-m="'+m+'">−</button></td></tr>';
  }
  if(!mats) mats = '<tr><td colspan="4" style="text-align:center;color:#666">—</td></tr>';
  return '<div class="card" id="k'+i+'">'+
    '<div class="row"><span class="pill">Kunde '+String(i+1).padStart(2,"0")+'</span>'+
    '<button class="btn" data-action="printK" data-i="'+i+'" style="margin-left:auto">PDF Arbeitsbericht</button>'+
    '<button class="btn" data-action="printKWeekly" data-i="'+i+'">PDF Wochenbericht (Kunde)</button></div>'+
    '<div class="grid cols2" style="margin-top:6px">'+
      '<div><label>Name</label><input type="text" value="'+escAttr(c.n)+'" data-action="setF" data-i="'+i+'" data-f="n"></div>'+
      '<div><label>Adresse</label><input type="text" value="'+escAttr(c.a)+'" data-action="setF" data-i="'+i+'" data-f="a"></div>'+
    '</div>'+
    '<div class="grid cols2" style="margin-top:6px">'+
      '<div><label>Auszuführende Arbeit</label><textarea data-action="setF" data-i="'+i+'" data-f="az">'+esc(c.az)+'</textarea></div>'+
      '<div><label>Ausgeführte Arbeit</label><textarea data-action="setF" data-i="'+i+'" data-f="ag">'+esc(c.ag)+'</textarea></div>'+
    '</div>'+
    '<div style="margin-top:8px"><b>Stunden</b><table><thead><tr><th>Monteur</th>'+st.tage.map(function(t){return '<th>'+t+'</th>'}).join('')+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table></div>'+
    '<div style="margin-top:8px"><b>Materialverbrauch</b> <button class="btn secondary" data-action="addM" data-i="'+i+'">+ Material</button>'+
      '<table style="margin-top:6px"><thead><tr><th>Material</th><th>Stückzahl</th><th>Bemerkung</th><th></th></tr></thead><tbody>'+mats+'</tbody></table></div>'+
  '</div>';
}

function attachDelegates(){
  // top inputs
  document.getElementById('kw').oninput = function(){ st.kw=this.value; save(); };
  document.getElementById('zr').oninput = function(){ st.zr=this.value; save(); };
  document.getElementById('sun').onchange = function(){ toggleSun(this.value); };
  document.getElementById('btnApplyTeam').onclick = applyTeam;
  document.getElementById('btnWeeklyAll').onclick = printWeekly;

  // customer toolbar
  document.getElementById('btnAddK').onclick = addKunde;
  document.getElementById('btnRemK').onclick = remKunde;
  document.getElementById('sel').onchange = function(){ setSel(this.value); };
  document.getElementById('btnScroll').onclick = scrollSel;

  // footer
  document.getElementById('sel2').onchange = function(){ setSel(this.value); };
  document.getElementById('btnScroll2').onclick = scrollSel;
  document.getElementById('btnPdfArbeitsbericht').onclick = function(){ printK(lastSel); };
  document.getElementById('btnPdfWochenKunde').onclick = function(){ printKWeekly(lastSel); };

  // kunden container delegation
  var kc = document.getElementById('kunden');
  kc.addEventListener('input', function(e){
    var t=e.target;
    if(t.matches('td.hcell input')){
      var i=+t.dataset.i, r=+t.dataset.r, d=+t.dataset.d;
      // sanitize on next frame to avoid IME flicker
      requestAnimationFrame(function(){
        setH(i,r,d,t.value);
        // enforce visible text inline (android quirk)
        t.style.color = '#fff';
        t.style.webkitTextFillColor = '#fff';
        t.style.backgroundColor = '#0f1116';
      });
      return;
    }
    if(t.matches('[data-action="setF"]')){
      var i=+t.dataset.i, f=t.dataset.f;
      setF(i,f,t.value);
      return;
    }
    if(t.matches('input[data-f], textarea[data-f]')){
      var i=+t.dataset.i, f=t.dataset.f, m=+t.dataset.m;
      setM(i,m,f,t.value);
      return;
    }
  });
  kc.addEventListener('click', function(e){
    var b=e.target.closest('button[data-action]'); if(!b) return;
    var act=b.dataset.action, i=+b.dataset.i;
    if(act==="addM") addM(i);
    else if(act==="delM"){ var m=+b.dataset.m; delM(i,m); }
    else if(act==="printK") printK(i);
    else if(act==="printKWeekly") printKWeekly(i);
  });
}

function computeAllVisibleSums(){
  document.querySelectorAll('#kunden tr').forEach(function(tr){
    var inputs = tr.querySelectorAll('td.hcell input');
    var sum = 0;
    inputs.forEach(function(inp){
      var v = inp.value.replace(/,/g,'.');
      var n = parseFloat(v);
      if(!isNaN(n)) sum += n;
    });
    var last = tr.querySelector('td.sum-cell');
    if (last){
      last.innerHTML = '<b>'+sum.toFixed(2)+'</b>';
    }
  });
}

function pdfHeader(title){ return '<div style="margin-bottom:4px;font-weight:700">'+title+'</div>'; }

function printK(i){
  var c=st.k[i];
  var rows='', head=st.tage.map(function(t){return '<th>'+t+'</th>'}).join('');
  for(var r=0;r<st.team.length;r++){
    var sum=0, cells='';
    for(var d=0;d<st.tage.length;d++){ var n=parseFloat(c.h[r][d]||0)||0; sum+=n; cells+='<td>'+n.toFixed(2)+'</td>'; }
    rows+='<tr><th style="text-align:left)">'+esc(st.team[r])+'</th>'+cells+'<td><b>'+sum.toFixed(2)+'</b></td></tr>';
  }
  var mats=''; for(var m=0;m<c.m.length;m++){ var it=c.m[m]; mats+='<tr><td>'+esc(it.b||'')+'</td><td>'+esc(it.s||'')+'</td><td>'+esc(it.r||'')+'</td></tr>'; }
  if(!mats) mats='<tr><td colspan="3" style="text-align:center;color:#666">—</td></tr>';
  var html='<!doctype html><html><head><meta charset="utf-8"><title>Arbeitsbericht</title>'+
    '<style>body{font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #777;padding:6px;text-align:center}.meta td{border:none;text-align:left;padding:2px 0}.signature{height:60px;border-top:1px solid #777;margin-top:24px}@page{size:A4;margin:15mm}</style></head><body>'+
    pdfHeader('Arbeitsbericht')+
    '<div style="margin-bottom:6px"><b>KW:</b> '+esc(st.kw)+' &nbsp; <b>Zeitraum:</b> '+esc(st.zr)+'</div>'+
    '<table class="meta"><tr><td><b>Kunde:</b> '+esc(c.n||'')+'</td></tr><tr><td><b>Adresse:</b> '+esc(c.a||'')+'</td></tr></table>'+
    '<h3>Auszuführende Arbeit</h3><div>'+esc((c.az||'').replace(/\\n/g,"<br>"))+'</div>'+
    '<h3>Ausgeführte Arbeit</h3><div>'+esc((c.ag||'').replace(/\\n/g,"<br>"))+'</div>'+
    '<h3>Stunden</h3><table><thead><tr><th>Monteur</th>'+head+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table>'+
    '<h3>Materialverbrauch</h3><table><thead><tr><th>Material</th><th>Stückzahl</th><th>Bemerkung</th></tr></thead><tbody>'+mats+'</tbody></table>'+
    '<div style="display:flex;gap:40px;margin-top:30px"><div style="flex:1"><div>Ort, Datum: ________________________________</div><div class="signature"></div><div>Unterschrift Kunde</div></div><div style="flex:1"><div>Ort, Datum: ________________________________</div><div class="signature"></div><div>Unterschrift Monteur</div></div></div>'+
    '<script>onload=function(){print()}</'+'script></body></html>';
  writePrint(html);
}

function printKWeekly(i){
  var c=st.k[i];
  var head=st.tage.map(function(t){return '<th>'+t+'</th>'}).join('');
  var rows='';
  for(var r=0;r<st.team.length;r++){
    var w=0,cells='';
    for(var d=0; d<st.tage.length; d++){ var n=parseFloat(c.h[r][d]||0)||0; w+=n; cells+='<td>'+n.toFixed(2)+'</td>'; }
    rows+='<tr><th style="text-align:left)">'+esc(st.team[r])+'</th>'+cells+'<td><b>'+w.toFixed(2)+'</b></td></tr>';
  }
  var lines=[]; for(var r=0;r<st.team.length;r++){ for(var d=0;d<st.tage.length;d++){ var h=parseFloat(c.h[r][d]||0)||0; if(h>0) lines.push({tag:st.tage[d], kunde:c.n||'', monteur:st.team[r], stunden:h}); } }
  var lrows = lines.map(function(x){ return '<tr><td>'+x.tag+'</td><td>'+esc(x.kunde)+'</td><td>'+esc(x.monteur)+'</td><td>'+x.stunden.toFixed(2)+'</td></tr>'; }).join('');
  if(!lrows) lrows = '<tr><td colspan="4" style="text-align:center;color:#666">—</td></tr>';
  var html='<!doctype html><html><head><meta charset="utf-8"><title>Wochenbericht (Kunde)</title>'+
    '<style>body{font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #777;padding:6px;text-align:center}@page{size:A4;margin:15mm}</style></head><body>'+
    pdfHeader('Wochenbericht (Kunde)')+
    '<div style="margin-bottom:6px"><b>KW:</b> '+esc(st.kw)+' &nbsp; <b>Zeitraum:</b> '+esc(st.zr)+'</div>'+
    '<div style="margin-bottom:6px"><b>Kunde:</b> '+esc(c.n||'')+' — <b>Adresse:</b> '+esc(c.a||'')+'</div>'+
    '<h3>Summen je Monteur / Tag</h3><table><thead><tr><th>Monteur</th>'+head+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table>'+
    '<h3 style="margin-top:16px">Kompakte Tagesliste</h3><table><thead><tr><th>Tag</th><th>Kunde</th><th>Monteur</th><th>Stunden</th></tr></thead><tbody>'+lrows+'</tbody></table>'+
    '<script>onload=function(){print()}</'+'script></body></html>';
  writePrint(html);
}

function printWeekly(){
  var grid = st.team.map(function(){ return st.tage.map(function(){ return 0; }); });
  for(var k=0;k<st.k.length;k++){ for(var r=0;r<st.team.length;r++){ for(var d=0; d<st.tage.length; d++){ var v=parseFloat(st.k[k].h[r][d]||0)||0; grid[r][d]+=v; } } }
  var head=st.tage.map(function(t){return '<th>'+t+'</th>'}).join('');
  var rows='';
  for(var r=0;r<st.team.length;r++){ var w=0,cells=''; for(var d=0; d<st.tage.length; d++){ w+=grid[r][d]; cells+='<td>'+grid[r][d].toFixed(2)+'</td>'; } rows+='<tr><th style="text-align:left)">'+esc(st.team[r])+'</th>'+cells+'<td><b>'+w.toFixed(2)+'</b></td></tr>'; }
  var lines=[]; for(var k=0;k<st.k.length;k++){ for(var r=0;r<st.team.length;r++){ for(var d=0;d<st.tage.length;d++){ var h=parseFloat(st.k[k].h[r][d]||0)||0; if(h>0) lines.push({tag:st.tage[d], kunde:st.k[k].n||'', monteur:st.team[r], stunden:h}); } } }
  var lrows = lines.map(function(x){ return '<tr><td>'+x.tag+'</td><td>'+esc(x.kunde)+'</td><td>'+esc(x.monteur)+'</td><td>'+x.stunden.toFixed(2)+'</td></tr>'; }).join('');
  if(!lrows) lrows = '<tr><td colspan="4" style="text-align:center;color:#666">—</td></tr>';
  var html='<!doctype html><html><head><meta charset="utf-8"><title>Wochenbericht</title>'+
    '<style>body{font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #777;padding:6px;text-align:center}@page{size:A4;margin:15mm}</style></head><body>'+
    pdfHeader('Wochenbericht (alle Kunden)')+
    '<div style="margin-bottom:6px"><b>KW:</b> '+esc(st.kw)+' &nbsp; <b>Zeitraum:</b> '+esc(st.zr)+'</div>'+
    '<h3>Summen je Monteur / Tag</h3><table><thead><tr><th>Monteur</th>'+head+'<th>Woche gesamt</th></tr></thead><tbody>'+rows+'</tbody></table>'+
    '<h3 style="margin-top:16px">Kompakte Tagesliste</h3><table><thead><tr><th>Tag</th><th>Kunde</th><th>Monteur</th><th>Stunden</th></tr></thead><tbody>'+lrows+'</tbody></table>'+
    '<script>onload=function(){print()}</'+'script></body></html>';
  writePrint(html);
}

function writePrint(html){
  var fr=document.getElementById('printFrame');
  var doc = fr.contentWindow || fr.contentDocument;
  if(doc.document) doc = doc.document;
  doc.open(); doc.write(html); doc.close();
}
function esc(s){ return (s||'').toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function escAttr(s){ return (s||'').toString().replace(/&/g,"&amp;").replace(/"/g,"&quot;"); }

// --- MOBILE VISIBILITY FIXES ---
function _patchInputsForMobile() {
  document.querySelectorAll('td.hcell input').forEach(function(inp){
    if (inp.dataset && inp.dataset.patched) return;
    try {
      inp.type = 'text';
      inp.setAttribute('inputmode', 'decimal');
      inp.autocapitalize = 'off';
      inp.autocomplete = 'off';
      inp.spellcheck = false;
      // enforce visible text inline (android quirk)
      inp.style.color = '#fff';
      inp.style.webkitTextFillColor = '#fff';
      inp.style.backgroundColor = '#0f1116';
      if (inp.dataset) inp.dataset.patched = '1';
    } catch(e){}
  });
}
function _sanitizeDecimal(v) {
  v = String(v || '').replace(/,/g, '.').replace(/[^0-9.]/g, '');
  var p = v.indexOf('.');
  if (p >= 0) v = v.slice(0, p + 1) + v.slice(p + 1).replace(/\./g, '');
  return v;
}
document.addEventListener('input', function(ev){
  var el = ev.target;
  if (!el || !el.matches || !el.matches('td.hcell input')) return;
  // sanitize on next frame to play nice with Android IME
  requestAnimationFrame(function(){
    var san = _sanitizeDecimal(el.value);
    if (san !== el.value) el.value = san;
    // inline enforce color (some devices ignore CSS temporarily while typing)
    el.style.color = '#fff'; el.style.webkitTextFillColor = '#fff'; el.style.backgroundColor = '#0f1116';
    var tr = el.closest && el.closest('tr');
    if (tr) {
      var sum = 0;
      tr.querySelectorAll('td.hcell input').forEach(function(i){
        var n = parseFloat(String(i.value).replace(',', '.'));
        if (!isNaN(n)) sum += n;
      });
      var cell = tr.querySelector('.sum-cell');
      if (cell) cell.innerHTML = '<b>' + sum.toFixed(2) + '</b>';
    }
    if (typeof renderLists === 'function') renderLists();
  });
});
document.addEventListener('DOMContentLoaded', function(){
  _patchInputsForMobile();
  document.querySelectorAll('#kunden tr').forEach(function(tr){
    var sum = 0;
    tr.querySelectorAll('td.hcell input').forEach(function(i){
      var n = parseFloat(String(i.value).replace(',', '.'));
      if (!isNaN(n)) sum += n;
    });
    var cell = tr.querySelector('.sum-cell');
    if (cell) cell.innerHTML = '<b>' + sum.toFixed(2) + '</b>';
  });
});
window._afterRenderPatch = function(){ _patchInputsForMobile(); };

// init
load();
if(!st.k || st.k.length===0){ st.k=[newK()]; }
render();
if(window._afterRenderPatch) _afterRenderPatch();
})();<script>
// --- MOBILE VISIBILITY HOTFIX (JS) ---
(function(){
  function sanitizeDecimal(v){
    v = String(v||'').replace(/,/g,'.').replace(/[^0-9.]/g,'');
    const p = v.indexOf('.');
    return p>=0 ? v.slice(0,p+1)+v.slice(p+1).replace(/\./g,'') : v;
  }
  // während der Eingabe sanft korrigieren & Repaint erzwingen
  document.addEventListener('input', function(ev){
    const el = ev.target;
    if (!el || !el.matches || !el.matches('td.hcell input')) return;
    // auf nächsten Frame legen (IME mag das lieber)
    requestAnimationFrame(function(){
      const val = sanitizeDecimal(el.value);
      if (val !== el.value) el.value = val;
      // Repaint-Trigger für Geräte, die Text kurz "unsichtbar" rendern
      el.style.color = '#fff';
      el.style.webkitTextFillColor = '#fff';
      el.style.backgroundColor = '#0f1116';
      // optional: Wochenübersicht neu
      if (typeof renderLists==='function') renderLists();
    });
  });
  // beim Fokus gleich sichere Styles setzen
  document.addEventListener('focusin', function(ev){
    const el = ev.target;
    if (!el || !el.matches || !el.matches('td.hcell input')) return;
    el.type = 'text';
    el.setAttribute('inputmode','decimal');
    el.autocapitalize = 'off';
    el.autocomplete = 'off';
    el.spellcheck = false;
    el.style.color = '#fff';
    el.style.webkitTextFillColor = '#fff';
    el.style.backgroundColor = '#0f1116';
  });
})();
</script>
</script>
</body>
</html>
